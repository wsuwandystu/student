<!-- Floating Microblog Button (upper right, below header) -->
<button id="microblog-toggle-btn" class="microblog-fab microblog-fab-top" aria-label="Open Microblog">ðŸ’¬ Microblog</button>

<!-- Microblog Side Panel -->
<aside id="microblog-panel" class="microblog-panel" tabindex="-1" aria-label="Microblog panel">
  <div class="microblog-panel-header">
    <button id="microblog-close-btn" class="microblog-close-btn" aria-label="Close Microblog">&times;</button>
    <h2 class="microblog-panel-title">Microblog</h2>
    <button id="guest-signup-toggle" class="guest-signup-toggle-btn">Guest Signup</button>
  </div>

  <!-- Guest Signup Form (initially hidden) -->
  <div id="guest-signup-form" class="guest-signup-container" style="display: none;">
    <h3 class="guest-signup-title">Quick Guest Signup</h3>
    <form id="guest-form" onsubmit="handleGuestSignup(event);">
      <div class="guest-form-group">
        <input type="text" id="guest-username" placeholder="Username" required>
      </div>
      <div class="guest-form-group">
        <input type="password" id="guest-password" placeholder="Password" required>
      </div>
      <p>
        <button type="submit" class="guest-submit-btn">Sign Up & Login</button>
      </p>
      <p id="guest-status-message" class="guest-status"></p>
    </form>
  </div>

  <div class="microblog-panel-content">
    <!-- MicroBlog Container -->
    <div id="microblog-playground">
      <em>Loading microblog posts...</em>
    </div>
  </div>
</aside>

<script type="module">
// Import required functions from config
import { pythonURI, javaURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';

// Microblog panel open/close logic
const microblogPanel = document.getElementById('microblog-panel');
const microblogFab = document.getElementById('microblog-toggle-btn');
const microblogCloseBtn = document.getElementById('microblog-close-btn');

function openMicroblogPanel() {
  microblogPanel.classList.add('open');
  microblogFab.style.display = 'none';
}
function closeMicroblogPanel() {
  microblogPanel.classList.remove('open');
  microblogFab.style.display = '';
}
microblogFab.onclick = openMicroblogPanel;
microblogCloseBtn.onclick = closeMicroblogPanel;

// Guest signup toggle logic
const guestSignupToggle = document.getElementById('guest-signup-toggle');
const guestSignupForm = document.getElementById('guest-signup-form');

guestSignupToggle.onclick = function() {
  if (guestSignupForm.style.display === 'none') {
    guestSignupForm.style.display = 'block';
  } else {
    guestSignupForm.style.display = 'none';
  }
};

// Guest signup handler with auto-login
window.handleGuestSignup = async function(event) {
  event.preventDefault();

  const username = document.getElementById('guest-username').value;
  const password = document.getElementById('guest-password').value;
  const statusMessage = document.getElementById('guest-status-message');
  const submitButton = document.querySelector('.guest-submit-btn');

  // Disable button and show loading state
  submitButton.disabled = true;
  submitButton.textContent = 'Creating Account...';
  statusMessage.textContent = '';
  statusMessage.style.color = '#666';

  const signupData = {
    uid: username,
    password: password
  };

  try {
    let accountExists = false;

    // Step 1: Try to create guest account using Flask backend
    statusMessage.textContent = 'Creating guest account...';
    const signupResponse = await fetch(`${pythonURI}/api/user/guest`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(signupData)
    });

    if (!signupResponse.ok) {
      // Account might already exist, so we'll try to login instead
      accountExists = true;
      statusMessage.textContent = 'Account exists, logging in...';
    } else {
      await signupResponse.json();
      statusMessage.textContent = 'Account created! Logging in...';
    }

    // Step 2: Login with the credentials (whether account was just created or already existed)
    const loginResponse = await fetch(`${pythonURI}/api/authenticate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify(signupData)
    });

    if (!loginResponse.ok) {
      throw new Error('Login failed - please check your credentials');
    }

    await loginResponse.json();

    // Success - stay on current page
    statusMessage.textContent = 'Success! You are now logged in.';
    statusMessage.style.color = 'green';

    // Hide the form after successful signup/login
    setTimeout(() => {
      guestSignupForm.style.display = 'none';
      // Reset form
      document.getElementById('guest-username').value = '';
      document.getElementById('guest-password').value = '';
      submitButton.disabled = false;
      submitButton.textContent = 'Sign Up & Login';
    }, 2000);

  } catch (error) {
    console.error('Guest signup error:', error);
    statusMessage.textContent = `Error: ${error.message}`;
    statusMessage.style.color = 'red';
    submitButton.disabled = false;
    submitButton.textContent = 'Sign Up & Login';
  }
};
</script>

<!-- Create/Edit Modal Overlay using Tailwind -->
<div id="microblog-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="microblog-modal-panel">
    <div class="microblog-modal-header">
      <button id="modal-close" class="microblog-modal-close" aria-label="Close Modal">&times;</button>
      <h2 id="modal-title" class="microblog-modal-title">Create Microblog Post</h2>
    </div>
    <form id="microblog-form" class="space-y-4">
      <input type="hidden" id="post-id" name="id">
      <div>
        <label class="block text-sm font-medium text-gray-700">Topic</label>
        <input id="topic-id" name="topicId" type="text" class="mt-1 block w-full border border-gray-300 rounded-md p-2" readonly>
      </div>
      <div class="microblog-form-group">
        <label for="content" class="microblog-form-label">Content <span class="required">*</span></label>
        <textarea id="content" name="content" required class=""></textarea>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Reply Modal -->
<div id="reply-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="microblog-modal-panel">
    <div class="microblog-modal-header">
      <button id="reply-modal-close" class="microblog-modal-close" aria-label="Close Reply Modal">&times;</button>
      <h2 id="reply-modal-title" class="microblog-modal-title">Reply to Post</h2>
    </div>
    <form id="reply-form" class="space-y-4">
      <input type="hidden" id="reply-post-id" name="postId">
      <div class="microblog-form-group">
        <label for="reply-content" class="microblog-form-label">Content <span class="required">*</span></label>
        <textarea id="reply-content" name="content" required class=""></textarea>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" id="reply-cancel-btn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Reply</button>
      </div>
    </form>
  </div>
</div>

<!--JavaScript Logic for MicroBlog -->
<script type="module">
// Imports for APIs used on this page
import { fetchPosts, createPost, updatePost, createReply, fetchReplies } from '/assets/js/api/microblog.js';

// Default Key for New MicroBlog Posts
const pagePermalink = '{{page.permalink}}';

// Create/Edit Modal Functions
function openModal({ mode, post = {} }) {
  document.getElementById('microblog-modal').classList.remove('hidden');
  document.getElementById('modal-title').textContent = mode === 'edit' ? 'Edit Microblog Post' : 'Create Microblog Post';
  document.getElementById('post-id').value = post.id || '';
  document.getElementById('topic-id').value = post.topicPath || pagePermalink;
  document.getElementById('content').value = post.content || '';
}
function closeModal() {
  document.getElementById('microblog-modal').classList.add('hidden');
}
document.getElementById('modal-close').onclick = closeModal;
document.getElementById('microblog-modal').onclick = function(e) {
  if (e.target === this) closeModal();
};

// Reply Modal Functions
function openReplyModal(postId) {
  document.getElementById('reply-modal').classList.remove('hidden');
  document.getElementById('reply-post-id').value = postId;
  document.getElementById('reply-content').value = '';
}
function closeReplyModal() {
  document.getElementById('reply-modal').classList.add('hidden');
  document.getElementById('reply-post-id').value = '';
  document.getElementById('reply-content').value = '';
}
document.getElementById('reply-modal-close').onclick = closeReplyModal;
document.getElementById('reply-cancel-btn').onclick = closeReplyModal;
document.getElementById('reply-modal').onclick = function(e) {
  if (e.target === this) closeReplyModal();
};

// Reply Form Submission
document.getElementById('reply-form').onsubmit = async function(e) {
  e.preventDefault();
  const postId = document.getElementById('reply-post-id').value;
  const content = document.getElementById('reply-content').value;
  const topicPath = pagePermalink || (window.location ? window.location.pathname : 'default');
  
  try {
    await createReply({ postId, content, topicPath });
    closeReplyModal();
    renderMicroblogTable(); // Refresh to show new reply
  } catch (err) {
    alert('Error posting reply: ' + err.message);
  }
};

// Load replies for a specific post
async function loadRepliesForPost(postId) {
  try {
    const repliesData = await fetchReplies(postId);
    const replies = repliesData.replies || repliesData || [];
    if (replies.length > 0) {
      // Find the row for this post
      const postRow = document.querySelector(`#post-row-${postId}`);
      if (postRow) {
        // Check if replies section already exists
        let repliesRow = document.querySelector(`#replies-row-${postId}`);
        if (!repliesRow) {
          // Create a new row for replies
          repliesRow = document.createElement('tr');
          repliesRow.id = `replies-row-${postId}`;
          repliesRow.className = 'replies-row';
          postRow.insertAdjacentElement('afterend', repliesRow);
        }
        
        // Format replies HTML
        const repliesHtml = replies.map(reply => {
          const replyDate = reply.timestamp ? new Date(reply.timestamp).toLocaleString() : '';
          return `
            <div class="reply-item ml-4 mt-2 p-2 rounded border-l-4 border-green-500">
              <div class="text-sm text-gray-600">
                ${reply.userName || 'Anonymous'} - ${replyDate}
              </div>
              <div class="mt-1">${escapeHtml(reply.content || '')}</div>
            </div>
          `;
        }).join('');
        
        repliesRow.innerHTML = `
          <td colspan="2" class="text-left p-2">
            <div class="replies-container">
              <strong class="text-sm text-gray-600">Replies (${replies.length}):</strong>
              ${repliesHtml}
            </div>
          </td>
        `;
      }
    }
  } catch (error) {
    console.error(`Error loading replies for post ${postId}:`, error);
  }
}

// Utility function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Save Button Listner for Update and Create
document.getElementById('microblog-form').onsubmit = async function(e) {
  e.preventDefault();
  const id = document.getElementById('post-id').value;
  const topicPath = document.getElementById('topic-id').value;
  const content = document.getElementById('content').value;
  try {
    // API calls to Update and Create Posts
    if (id) {
      await updatePost({ id, content, topicPath });
    } else {
      await createPost({ content, topicPath });
    }
    closeModal();
    renderMicroblogTable();
  } catch (err) {
    alert('Error saving post: ' + err.message);
  }
};

// MicroBlog Table Manager
async function renderMicroblogTable() {
    const container = document.getElementById('microblog-playground');
    try {
        // Determine filter mode and pass page if needed
        let pageArg = undefined;
        if (window.__microblogFilterMode === undefined || window.__microblogFilterMode === 'page') {
          // Use current page as filter; fallback to location.pathname or a default string
          pageArg = window.location ? window.location.pathname : 'default';
        }
        // API call to Read former Posts
        const data = await fetchPosts(pageArg);
        // SVG icons for Create (+) and Edit (pencil)
        const createIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="microblog-filter-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>`;
        const editIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="microblog-filter-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.586-6.586a2 2 0 112.828 2.828L11.828 15.828a4 4 0 01-2.828 1.172H7v-2a4 4 0 011.172-2.828z" /></svg>`;
        const replyIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="microblog-filter-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>`;
        // Single page icon (default)
        const pageIcon = `<span class="microblog-filter-icon microblog-filter-page" id="page-icon" title="Show this page only"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="6" y="4" width="12" height="16" rx="2" fill="white" stroke="white" stroke-width="1.5"/><rect x="8" y="6" width="8" height="12" rx="1" fill="#9333ea" stroke="white" stroke-width="1.5"/></svg></span>`;
        // Many pages icon (secondary option)
        const manyPagesIcon = `<span class="microblog-filter-icon microblog-filter-many" id="many-pages-icon" title="Show all pages"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><rect x="7" y="15" width="10" height="6" rx="2" fill="#60a5fa" stroke="white" stroke-width="1.2"/><rect x="5" y="11" width="12" height="6" rx="2" fill="#2563eb" stroke="white" stroke-width="1.2"/><rect x="3" y="7" width="12" height="6" rx="2" fill="#1e40af" stroke="white" stroke-width="1.2"/></g></svg></span>`;
        // Create and Page Icons
        const controlsInfo = `
          <span id="filter-icons" class="microblog-filter-controls">
            <button id="create-btn" class="microblog-btn microblog-btn-create" title="Create Post">${createIcon}</button>
            ${pageIcon}
            ${manyPagesIcon}
          </span>
        `;

        // Table: Keys and Special Formatting
        const analytics = [
          { key: 'userName' },
          { key: 'timestamp', format: ts => {
              if (!ts) return '';
              const d = new Date(ts);
              if (isNaN(d)) return ts;
              return d.toLocaleString();
            }
          },
          { key: 'characterCount', format: v => `Count: ${v}` }
        ];
        const message = [
          { key: 'topicPath', format: v => `Topic: ${v}` },
          { key: 'content' }
        ];

        // Table: columns
        let head = `
            <thead>
                <tr>
                    <th style="width:30%">Analytics</th>
                    <th>Message</th>
                </tr>
            </thead>
        `;

        // Table: rows; generated from microblog data
        let genBody = '';
        (data.microblogs || []).forEach(post => {
            const analyticsCell = analytics.map(f => {
              let value = post[f.key] ?? '';
              if (f.format) value = f.format(value);
              return `<div>${value}</div>`;
            }).join('');
            // Edit and Reply buttons inline with Topic
            const messageCell = message.map(f => {
              let value = post[f.key] ?? '';
              if (f.key === 'topicPath') {
                value = (f.format ? f.format(value) : value) +
                  ` <button class='edit-btn ml-2' data-id='${post.id}' title='Edit'>${editIcon}</button>` +
                  ` <button class='reply-btn ml-2' data-id='${post.id}' title='Reply'>${replyIcon}</button>`;
              } else if (f.format) {
                value = f.format(value);
              }
              return `<div>${value}</div>`;
            }).join('');
            genBody += `<tr id="post-row-${post.id}"><td class="text-left">${analyticsCell}</td><td class="text-left">${messageCell}</td></tr>`;
        });

        // Table: body
        let body = `
        <tbody>
            ${genBody}
        </tbody>
        `;


        // Table: set container with scrollable wrapper
        container.innerHTML = `
        <div class="max-h-[45vh] sm:max-h-[60vh] lg:max-h-[70vh] overflow-y-auto" style="max-height:70vh;">
          <table id="microblog-table" border="1" style="border-collapse:collapse; margin-top:1em; width:100%;">
              ${head}
              ${body}
          </table>
        </div>
        `;

        // Wait for DOM update, then initialize DataTables
        setTimeout(async () => {
        // JQuery micro-table Bottom and Top control updates
        if (window.jQuery && $('#microblog-table').length) {
            $('#microblog-table').DataTable({
                initComplete: function() {
                    // Top controls (Show entries)
                    const lengthDiv = document.querySelector('.dataTables_length');
                    if (lengthDiv) {
                      lengthDiv.style.display = 'flex';
                      lengthDiv.style.alignItems = 'center';
                      lengthDiv.insertAdjacentHTML('afterbegin', controlsInfo);
                      lengthDiv.querySelectorAll('*').forEach(el => {
                        el.style.marginTop = '0';
                        el.style.marginBottom = '0';
                      });
                      const createBtn = document.getElementById('create-btn');
                      if (createBtn) createBtn.onclick = () => openModal({ mode: 'create' });
                    }
                    // Bottom controls (prefix to info)
                    const infoDiv = document.querySelector('.dataTables_info');
                    if (infoDiv) {
                      infoDiv.style.display = 'flex';
                      infoDiv.style.alignItems = 'center';
                      infoDiv.innerHTML = controlsInfo + infoDiv.innerHTML;
                      // Only bind if not already bound (avoid duplicate IDs)
                      const btns = infoDiv.querySelectorAll('#create-btn');
                      btns.forEach(btn => btn.onclick = () => openModal({ mode: 'create' }));
                    }
                    // Filter mode logic (default: page, people = all)
                    window.__microblogFilterMode = 'page';
                    function setFilterMode(mode) {
                      window.__microblogFilterMode = mode;
                      // Update icon backgrounds for visual feedback
                      const pageIconEl = document.getElementById('page-icon');
                      const manyPagesIconEl = document.getElementById('many-pages-icon');
                      if (pageIconEl && manyPagesIconEl) {
                        if (mode === 'page') {
                          pageIconEl.style.background = '#9333ea'; // purple
                          manyPagesIconEl.style.background = '#2563eb'; // blue
                          pageIconEl.style.opacity = '1';
                          manyPagesIconEl.style.opacity = '0.5';
                        } else {
                          manyPagesIconEl.style.background = '#2563eb';
                          pageIconEl.style.background = '#9333ea';
                          manyPagesIconEl.style.opacity = '1';
                          pageIconEl.style.opacity = '0.5';
                        }
                      }
                      // Re-render table with new filter
                      renderMicroblogTable();
                    }
                    setTimeout(() => {
                      // Bind ALL filter icons (top and bottom)
                      document.querySelectorAll('#page-icon').forEach(el => {
                        el.onclick = () => setFilterMode('page');
                      });
                      document.querySelectorAll('#many-pages-icon').forEach(el => {
                        el.onclick = () => setFilterMode('people');
                      });
                      // Only set default filter if not already set
                      if (!window.__microblogFilterModeInitialized) {
                        window.__microblogFilterModeInitialized = true;
                        setFilterMode('page');
                      }
                    }, 0);
                }
            });
            // Bind edit buttons using event delegation so it works on all pages
            $('#microblog-table').off('click', '.edit-btn').on('click', '.edit-btn', function() {
              const id = $(this).data('id');
              const post = (data.microblogs || []).find(p => p.id == id);
              openModal({ mode: 'edit', post });
            });
            // Bind reply buttons
            $('#microblog-table').off('click', '.reply-btn').on('click', '.reply-btn', async function() {
              const postId = $(this).data('id');
              openReplyModal(postId);
            });
            
            // Load and display replies for each post
            for (const post of (data.microblogs || [])) {
              await loadRepliesForPost(post.id);
            }
        }
        }, 0);
    } catch (error) {
        container.innerHTML = `<div style="color:red;">Failed to load microblog posts: ${error.message}</div>`;
    }
}
renderMicroblogTable();
</script>
